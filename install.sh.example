#!/bin/bash

set -e

# Set the repository and Mastodon paths
TANGERINEUI="/home/mastodon/TangerineUI"
MASTODON="/home/mastodon/live"

# Navigate to the repository
cd "$TANGERINEUI" || { echo "Tangerine UI repository directory not found: $REPO"; exit 1; }

# Pull the latest changes from the repository
git pull || { echo "Failed to pull latest changes from the Tangerine UI repository"; exit 1; }

# Copy styles from the Mastodon repository to the target directory
cp -r "./mastodon/app/javascript/styles/"* "$MASTODON/app/javascript/styles"

# Add Tangerine UI to themes.yml if not already present
THEME_FILE="$MASTODON/config/themes.yml"
THEME_LINES=(
    "tangerineui: styles/tangerineui.scss"
    "tangerineui-purple: styles/tangerineui-purple.scss"
    "tangerineui-cherry: styles/tangerineui-cherry.scss"
    "tangerineui-lagoon: styles/tangerineui-lagoon.scss"
)

# Check if the themes are already present
all_present=true
for line in "${THEME_LINES[@]}"; do
    if ! grep -Fxq "$line" "$THEME_FILE"; then
        all_present=false
        break
    fi
done

if [ "$all_present" = false ]; then
    if [ -f "$THEME_FILE" ]; then
        {
            for line in "${THEME_LINES[@]}"; do
                echo "$line"
            done
        } >> "$THEME_FILE"
        echo "Added Tangerine UI themes to $THEME_FILE."
    else
        echo "Themes file not found: $THEME_FILE"
        exit 1
    fi
else
    echo "Tangerine UI is already present in $THEME_FILE. Skipping this step."
fi

# Navigate to the Mastodon directory
cd "$MASTODON" || { echo "Mastodon directory not found: $MASTODON"; exit 1; }

# Precompile assets in production mode
RAILS_ENV=production bundle exec rails assets:precompile

echo ""
echo "Tangerine UI was successfully installed."
echo "Restart all Mastodon services for the changes to take effect."
